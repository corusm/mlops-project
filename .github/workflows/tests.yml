name: "Run tests"

on:
  push:
    branches: [ master, main, dvc-gh-actions ] # remove before merge!
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Python 3.11
      uses: actions/setup-python@v2
      with:
        python-version: 3.11

    - uses: iterative/setup-dvc@v1
    - name: Auth
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/311990494126/locations/global/workloadIdentityPools/github/providers/my-repo'
        project_id: 'dtumlops-g62v2'
        service_account: 'github-actions@dtumlops-g62v2.iam.gserviceaccount.com'
        token_format: "access_token"

    - name: Get data
      run: dvc pull
      # resource: https://github.com/google-github-actions/auth#preferred-direct-workload-identity-federation
      # github issue: https://github.com/iterative/cml/issues/862#issuecomment-1107689427


    # - name: Cache Python dependecies
    #   uses: actions/cache@v2
    #   with:
    #     path: ~/.cache/pip
    #     key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/requirements_tests.txt') }}
    #     restore-keys: |
    #       ${{ runner.os }}-pip-

    # - name: Install dependencies
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install -r requirements.txt
    #     pip install -r requirements_tests.txt

    # - name: Test with pytest
    #   run: |
    #     pip install pytest
    #     pytest -v
